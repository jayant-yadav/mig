From afa51734bab967cefe527be6349eff13abb794e1 Mon Sep 17 00:00:00 2001
From: jayant-yadav <jayantyadav202@gmail.com>
Date: Wed, 15 Mar 2017 21:19:02 +0530
Subject: [PATCH] added if conditions to handle simultaneous status and invperm
 updation

---
 mig-api/investigator_endpoints.go | 40 +++++++++++++++++++++++++--------------
 1 file changed, 26 insertions(+), 14 deletions(-)

diff --git a/mig-api/investigator_endpoints.go b/mig-api/investigator_endpoints.go
index 7723360..59b6ce4 100644
--- a/mig-api/investigator_endpoints.go
+++ b/mig-api/investigator_endpoints.go
@@ -171,23 +171,35 @@ func updateInvestigator(respWriter http.ResponseWriter, request *http.Request) {
 	if inv.Status == "" && invperm == "" {
 		panic("No updates to the investigator were specified")
 	}
-	if inv.Status != "" {
-		// update the investigator status in database
-		err = ctx.DB.UpdateInvestigatorStatus(inv)
-		if err != nil {
-			panic(err)
+	else{
+		if inv.Status != "" && invperm==""{
+			// update the investigator status in database
+			err = ctx.DB.UpdateInvestigatorStatus(inv)
+			if err != nil {
+				panic(err)
+			}
+			ctx.Channels.Log <- mig.Log{OpID: opid, Desc: fmt.Sprintf("Investigator %.0f status changed to %s", inv.ID, inv.Status)}
 		}
-		ctx.Channels.Log <- mig.Log{OpID: opid, Desc: fmt.Sprintf("Investigator %.0f status changed to %s", inv.ID, inv.Status)}
-	} else {
-		err = json.Unmarshal([]byte(invperm), &inv.Permissions)
-		if err != nil {
-			panic(err)
+		else if inv.Status == "" && invperm!=""{
+			err = json.Unmarshal([]byte(invperm), &inv.Permissions)
+			if err != nil {
+				panic(err)
+			}
+			err = ctx.DB.UpdateInvestigatorPerms(inv)
+			if err != nil {
+				panic(err)
+			}
+			ctx.Channels.Log <- mig.Log{OpID: opid, Desc: fmt.Sprintf("Investigator %.0f permissions changed", inv.ID)}
 		}
-		err = ctx.DB.UpdateInvestigatorPerms(inv)
-		if err != nil {
-			panic(err)
+		else {
+			// when both status and permissions are changed
+			errStatus = ctx.DB.UpdateInvestigatorStatus(inv)
+			errInvperm = json.Unmarshal([]byte(invperm), &inv.Permissions)
+			if errStatus != nil || errInvperm!= nil {
+				panic(err)
+			}
+			ctx.Channels.Log <- mig.Log{OpID: opid, Desc: fmt.Sprintf("Investigator %.0f permissions changed and status changed to %s", inv.ID, inv.Status)}
 		}
-		ctx.Channels.Log <- mig.Log{OpID: opid, Desc: fmt.Sprintf("Investigator %.0f permissions changed", inv.ID)}
 	}
 	err = resource.AddItem(cljs.Item{
 		Href: fmt.Sprintf("%s/investigator?investigatorid=%.0f", ctx.Server.BaseURL, inv.ID),
-- 
2.7.4

